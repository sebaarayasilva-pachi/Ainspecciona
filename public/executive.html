<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>App Ejecutivo · Ainspecciona</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #F6F7F9;
      color: #0f172a;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
    }
    .nav {
      padding: 16px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      color: inherit;
      font-weight: 800;
    }
    .brand img { height: 36px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      border: 1px solid transparent;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
      text-decoration: none;
    }
    .btn.outline {
      background: #fff;
      color: #1f2937;
      border-color: #e5e7eb;
    }
    main {
      max-width: 720px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      margin-bottom: 16px;
    }
    .muted { color: #64748b; font-size: 13px; }
    .row {
      display: grid;
      gap: 10px;
      margin: 12px 0;
    }
    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
    }
    .caseCard {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 14px;
      display: grid;
      gap: 8px;
    }
    .progress {
      height: 8px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress > div {
      height: 100%;
      background: #2563eb;
      width: 0%;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <a class="brand" href="/">
        <img src="/assets/Logo Ainspecciona.png" alt="Ainspecciona" />
      </a>
      <button class="btn outline hidden" id="logoutBtn" type="button">Salir</button>
    </div>
  </header>

  <main>
    <div class="card" id="loginCard">
      <h2>Ingreso ejecutivo</h2>
      <div class="muted">Accede a tus inspecciones asignadas.</div>
      <div class="row">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" placeholder="correo@empresa.com" />
      </div>
      <div class="row">
        <label for="loginPass">Clave</label>
        <input id="loginPass" type="password" placeholder="Tu clave" />
      </div>
      <button class="btn" id="loginBtn" type="button">Ingresar</button>
      <div class="muted" id="loginNote"></div>
    </div>

    <div class="card hidden" id="casesCard">
      <h2>Mis inspecciones</h2>
      <div class="muted" id="userLine"></div>
      <div id="casesList" style="margin-top: 12px;"></div>
    </div>
  </main>

  <script>
    async function getMe() {
      const res = await fetch("/api/executive/me");
      if (!res.ok) return null;
      const data = await res.json();
      return data?.user || null;
    }

    async function getCases() {
      const res = await fetch("/api/executive/cases");
      if (!res.ok) return [];
      const data = await res.json();
      return data?.cases || [];
    }

    function renderCases(cases) {
      const list = document.getElementById("casesList");
      list.innerHTML = "";
      if (!cases.length) {
        list.textContent = "No tienes inspecciones asignadas.";
        return;
      }
      cases.forEach((c) => {
        const card = document.createElement("div");
        card.className = "caseCard";
        const title = document.createElement("div");
        title.textContent = c.address || "Dirección no informada";
        const addr = document.createElement("div");
        addr.className = "muted";
        addr.textContent = c.ownerName || "Nombre no informado";
        const meta = document.createElement("div");
        meta.className = "muted";
        meta.textContent = `${c.propertyType === "HOUSE" ? "Casa" : "Departamento"} · ${c.bedrooms}D / ${c.bathrooms}B`;
        const progress = document.createElement("div");
        progress.className = "progress";
        const bar = document.createElement("div");
        bar.style.width = `${c.progress?.pct || 0}%`;
        progress.appendChild(bar);
        const pct = document.createElement("div");
        pct.className = "muted";
        pct.textContent = `Avance: ${c.progress?.pct || 0}%`;
        const action = document.createElement("a");
        action.className = "btn";
        action.textContent = "Iniciar Inspección";
        action.href = c.captureUrl || "#";
        action.target = "_blank";
        if (!c.captureUrl) {
          action.classList.add("outline");
          action.textContent = "Sin link de captura";
          action.href = "#";
        }
        card.appendChild(title);
        card.appendChild(addr);
        card.appendChild(meta);
        card.appendChild(progress);
        card.appendChild(pct);
        card.appendChild(action);
        list.appendChild(card);
      });
    }

    async function handleLogin() {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPass").value;
      const note = document.getElementById("loginNote");
      note.textContent = "";
      if (!email || !password) {
        note.textContent = "Ingresa email y clave.";
        return;
      }
      const res = await fetch("/api/executive/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });
      if (!res.ok) {
        note.textContent = "Credenciales inválidas.";
        return;
      }
      await loadApp();
    }

    async function loadApp() {
      const user = await getMe();
      const loginCard = document.getElementById("loginCard");
      const casesCard = document.getElementById("casesCard");
      const logoutBtn = document.getElementById("logoutBtn");
      if (!user) {
        loginCard.classList.remove("hidden");
        casesCard.classList.add("hidden");
        logoutBtn.classList.add("hidden");
        return;
      }
      loginCard.classList.add("hidden");
      casesCard.classList.remove("hidden");
      logoutBtn.classList.remove("hidden");
      document.getElementById("userLine").textContent = `Hola, ${user.fullName}`;
      const cases = await getCases();
      renderCases(cases);
    }

    document.getElementById("loginBtn").addEventListener("click", handleLogin);
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await fetch("/api/executive/logout", { method: "POST" });
      await loadApp();
    });

    loadApp().catch(() => {});
  </script>
</body>
</html>
