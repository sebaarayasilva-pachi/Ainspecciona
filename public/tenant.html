<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel · Ainspecciona</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #F6F7F9;
      color: #0f172a;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
    }
    .nav {
      max-width: none;
      margin: 0;
      padding: 20px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
      font-weight: 800;
    }
    .brand img { height: 56px; }
    .topActions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      border: 1px solid transparent;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    .btn.outline {
      background: #fff;
      color: #1f2937;
      border-color: #e5e7eb;
    }
    main {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: calc(100vh - 96px);
    }
    aside {
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      padding: 24px 18px;
    }
    .asideTitle {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
      margin: 0 0 12px;
      font-weight: 700;
    }
    .menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .menu a {
      text-decoration: none;
      color: #0f172a;
      font-weight: 600;
      padding: 10px 12px;
      border-radius: 10px;
    }
    .menu a.active {
      background: #eef2ff;
      color: #1d4ed8;
    }
    .content {
      padding: 28px 28px 80px;
    }
    .content.hidden { display: none; }
    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      margin-bottom: 18px;
    }
    h1 { margin: 0 0 8px; font-size: 26px; }
    .muted { color: #64748b; }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    .inspectionForm {
      display: grid;
      gap: 16px;
      margin-top: 12px;
    }
    .inspectionForm .row {
      border-bottom: none;
      padding: 0;
      grid-template-columns: 1fr;
      gap: 6px;
    }
    .formSectionTitle {
      font-size: 13px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #64748b;
      margin: 2px 0 6px;
    }
    .formHint {
      font-size: 12px;
      color: #94a3b8;
      margin-top: -4px;
    }
    .row-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .checks {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .checks label {
      font-weight: 600;
      color: #374151;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .row:last-child { border-bottom: none; }
    label { font-weight: 600; font-size: 14px; }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
    }
    .note {
      font-size: 12px;
      color: #64748b;
      margin-top: 10px;
    }
    .userGrid {
      display: grid;
      grid-template-columns: 1.2fr 1fr 140px 160px 140px 120px 140px;
      gap: 10px;
      align-items: center;
    }
    .inspectionGrid {
      display: grid;
      grid-template-columns: 1.2fr 1fr 140px 120px 120px 140px;
      gap: 10px;
      align-items: center;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      background: #EEF2FF;
      color: #1D4ED8;
    }
    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
      aside { border-right: none; border-bottom: 1px solid #e5e7eb; }
      .grid { grid-template-columns: 1fr; }
      .row-2 { grid-template-columns: 1fr; }
      .checks { grid-template-columns: 1fr; }
      .userGrid { grid-template-columns: 1fr; }
      .inspectionGrid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <a class="brand" href="/">
        <img src="/assets/Logo Ainspecciona.png" alt="Ainspecciona" />
      </a>
      <div class="topActions">
        <div id="tenantName" class="muted"></div>
        <button class="btn outline" id="logoutBtn" type="button">Salir</button>
      </div>
    </div>
  </header>

  <main>
    <aside>
      <div class="asideTitle">Panel Tenant</div>
      <nav class="menu">
        <a class="active" data-section-link="users" href="#users">Usuarios</a>
        <a data-section-link="inspections" href="#inspections">Inspecciones</a>
      </nav>
    </aside>

    <section class="content" id="users" data-section="users">
      <h1>Usuarios</h1>
      <div class="muted">Crea usuarios y asigna roles.</div>

      <div class="card">
        <h3>Nuevo usuario</h3>
        <div class="userGrid" style="margin-top: 10px;">
          <input id="userFullName" type="text" placeholder="Nombre completo" />
          <input id="userEmail" type="email" placeholder="correo@empresa.com" />
          <input id="userPhone" type="text" placeholder="+569..." />
          <select id="userRole">
            <option value="TENANT_ADMIN">Administrador</option>
            <option value="TENANT_USER" selected>Ejecutivo</option>
          </select>
          <div class="badge">PENDIENTE</div>
          <div style="display:flex; gap:8px;">
            <button class="btn outline" id="saveUserBtn" type="button">Guardar</button>
            <button class="btn" id="inviteUserBtn" type="button">Invitar</button>
          </div>
        </div>
        <div class="note" id="userNote"></div>
      </div>

      <div class="card">
        <h3>Listado de usuarios</h3>
        <div class="userGrid" id="userHeader">
          <div class="muted">Nombre</div>
          <div class="muted">Email</div>
          <div class="muted">Teléfono</div>
          <div class="muted">Rol</div>
          <div class="muted">Invitación</div>
          <div class="muted">Estado</div>
          <div class="muted">Acción</div>
        </div>
        <div class="userGrid" id="userList"></div>
      </div>
    </section>

    <section class="content hidden" id="inspections" data-section="inspections">
      <h1>Inspecciones</h1>
      <div class="muted">Genera una nueva inspección y asigna a un ejecutivo.</div>

      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
        <h3 style="margin:0;">Inspecciones</h3>
        <button class="btn outline" id="toggleInspectionFormBtn" type="button">Agregar inspección</button>
      </div>

      <div class="inspectionForm hidden" id="inspectionFormCard">
        <div class="card">
          <h3 style="margin:0 0 8px;">Propietario</h3>
          <div class="row-2">
            <div class="row">
              <label for="ownerName">Nombre</label>
              <input id="ownerName" type="text" placeholder="Nombre completo" />
            </div>
            <div class="row">
              <label for="ownerRut">RUT</label>
              <input id="ownerRut" type="text" placeholder="RUT" />
            </div>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">Propiedad</h3>
          <div class="row-2">
            <div class="row">
              <label for="propertyRol">ROL</label>
              <input id="propertyRol" type="text" placeholder="ROL" />
            </div>
            <div class="row">
              <label for="propertyComuna">Comuna</label>
              <input id="propertyComuna" type="text" placeholder="Comuna" />
            </div>
          </div>
          <div class="row-2">
            <div class="row">
              <label for="propertyStreet">Calle</label>
              <input id="propertyStreet" type="text" placeholder="Calle" />
            </div>
            <div class="row">
              <label for="propertyNumber">Número</label>
              <input id="propertyNumber" type="text" placeholder="Número" />
            </div>
          </div>
          <div class="row-2">
            <div class="row">
              <label for="propertyDept">Depto</label>
              <input id="propertyDept" type="text" placeholder="Depto / Interior" />
            </div>
            <div class="row">
              <label for="propertyAddress">Dirección completa</label>
              <input id="propertyAddress" type="text" placeholder="Dirección completa" />
            </div>
          </div>
          <div class="row-2">
            <div class="row">
              <label for="propertyOperationType">Tipo operación</label>
              <input id="propertyOperationType" type="text" placeholder="Venta / Arriendo" />
            </div>
            <div class="row">
              <label for="propertySurface">Superficie (m2)</label>
              <input id="propertySurface" type="text" placeholder="Ej: 45" />
            </div>
          </div>
          <div class="formHint">Si completas calle, número y comuna, la dirección se arma sola.</div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">Características</h3>
          <div class="grid">
            <div class="row">
              <label for="propertyType">Tipo de propiedad</label>
              <select id="propertyType">
                <option value="DEPARTMENT">Departamento</option>
                <option value="HOUSE">Casa</option>
              </select>
            </div>
            <div class="row">
              <label for="bathroomsCount">Baños</label>
              <input id="bathroomsCount" type="number" min="1" value="1" />
            </div>
            <div class="row">
              <label for="bedroomsCount">Dormitorios</label>
              <input id="bedroomsCount" type="number" min="0" value="1" />
            </div>
          </div>
          <div class="grid">
            <div class="row">
              <label for="propertyAgeRange">Antigüedad</label>
              <select id="propertyAgeRange">
                <option value="">—</option>
                <option value="LESS_THAN_10_YEARS">Menos de 10 años</option>
                <option value="BETWEEN_10_AND_30_YEARS">Entre 10 y 30 años</option>
                <option value="MORE_THAN_30_YEARS">Más de 30 años</option>
              </select>
            </div>
            <div class="row">
              <label for="floorType">Tipo de piso</label>
              <select id="floorType">
                <option value="CONCRETE">Hormigón</option>
                <option value="WOOD">Madera</option>
                <option value="MIXED">Mixto</option>
              </select>
            </div>
            <div class="row">
              <label for="yearBuilt">Año construcción</label>
              <input id="yearBuilt" type="number" min="1900" max="2100" placeholder="Ej: 2015" />
            </div>
          </div>
          <div class="checks">
            <label><input type="checkbox" id="hasPatio" /> Tiene patio</label>
            <label><input type="checkbox" id="hasAttic" /> Tiene entretecho</label>
            <label><input type="checkbox" id="hasLaundry" /> Tiene loggia</label>
          </div>
          <div class="row" style="margin-top: 12px;">
            <label for="caseExecutive">Ejecutivo</label>
            <select id="caseExecutive"></select>
          </div>
          <div class="actions">
            <button class="btn" id="createCaseBtn" type="button">Crear inspección</button>
          </div>
          <div class="note" id="caseNote"></div>
        </div>
      </div>

      <div class="card">
        <h3>Inspecciones ingresadas</h3>
        <div class="inspectionGrid" id="inspectionHeader">
          <div class="muted">Dirección</div>
          <div class="muted">Ejecutivo</div>
          <div class="muted">Tipo</div>
          <div class="muted">Estado</div>
          <div class="muted">Avance</div>
          <div class="muted">Creada</div>
        </div>
        <div class="inspectionGrid" id="inspectionList"></div>
      </div>
    </section>
  </main>

  <script>
    function formatDateShort(value) {
      if (!value) return "—";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return "—";
      return new Intl.DateTimeFormat("es-CL", { dateStyle: "medium" }).format(d);
    }

    function handleUnauthorized(res) {
      if (res.status === 401) {
        window.location.href = "/";
        return true;
      }
      return false;
    }

    async function readErrorMessage(res) {
      try {
        const data = await res.json();
        return data?.error || data?.message || `Error ${res.status}`;
      } catch {
        return `Error ${res.status}`;
      }
    }

    function buildActivationLink(activationUrl) {
      if (!activationUrl) return `${window.location.origin}/activate`;
      return `${window.location.origin}${activationUrl}`;
    }

    async function loadTenant() {
      const res = await fetch("/api/tenant/me");
      if (!res.ok) {
        window.location.href = "/";
        return null;
      }
      const data = await res.json();
      document.getElementById("tenantName").textContent = data?.tenant?.name || "";
      return data?.tenant;
    }

    async function loadUsers() {
      const res = await fetch("/api/tenant/users");
      if (handleUnauthorized(res)) return [];
      if (!res.ok) return [];
      const data = await res.json();
      return data?.users || [];
    }

    async function loadInspections() {
      const res = await fetch("/api/tenant/inspections");
      if (handleUnauthorized(res)) return [];
      if (!res.ok) return [];
      const data = await res.json();
      return data?.inspections || [];
    }

    async function renderUsers() {
      const users = await loadUsers();
      const list = document.getElementById("userList");
      const execSelect = document.getElementById("caseExecutive");
      list.innerHTML = "";
      execSelect.innerHTML = "";
      if (!users.length) {
        list.appendChild(Object.assign(document.createElement("div"), { className: "note", textContent: "Sin usuarios aún." }));
        return;
      }
      users.forEach((u) => {
        const fullName = document.createElement("div");
        fullName.textContent = u.fullName || "—";
        const email = document.createElement("div");
        email.textContent = u.email || "—";
        const phone = document.createElement("div");
        phone.textContent = u.phone || "—";
        const role = document.createElement("div");
        role.textContent = u.role === "TENANT_ADMIN" ? "Administrador" : "Ejecutivo";
        const invited = document.createElement("div");
        invited.textContent = formatDateShort(u.invitedAt);
        const status = document.createElement("div");
        status.textContent = u.status || "PENDING";
        const action = document.createElement("div");
        action.style.display = "flex";
        action.style.gap = "8px";
        action.style.flexWrap = "wrap";

        const activateBtn = document.createElement("button");
        activateBtn.className = "btn outline";
        activateBtn.textContent = "Activar";
        activateBtn.addEventListener("click", async () => {
          const res = await fetch(`/api/tenant/users/${u.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "ACTIVE" })
          });
          if (handleUnauthorized(res)) return;
          const note = document.getElementById("userNote");
          if (res.ok) {
            note.textContent = "Usuario activado.";
            renderUsers().catch(() => {});
          } else {
            note.textContent = "No se pudo activar.";
          }
        });

        const editBtn = document.createElement("button");
        editBtn.className = "btn outline";
        editBtn.textContent = "Editar";
        editBtn.addEventListener("click", async () => {
          const fullName = prompt("Nombre", u.fullName || "") || u.fullName || "";
          const phone = prompt("Teléfono", u.phone || "") || u.phone || "";
          const role = prompt("Rol (TENANT_ADMIN/TENANT_USER)", u.role || "TENANT_USER") || u.role || "TENANT_USER";
          const res = await fetch(`/api/tenant/users/${u.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ fullName, phone, role })
          });
          const note = document.getElementById("userNote");
          if (handleUnauthorized(res)) return;
          if (res.ok) {
            note.textContent = "Usuario actualizado.";
            renderUsers().catch(() => {});
          } else {
            note.textContent = "No se pudo editar.";
          }
        });

        const reinviteBtn = document.createElement("button");
        reinviteBtn.className = "btn outline";
        reinviteBtn.textContent = "Reinvitar";
        reinviteBtn.addEventListener("click", async () => {
          const res = await fetch(`/api/tenant/users/${u.id}/invite`, { method: "POST" });
          if (handleUnauthorized(res)) return;
          if (!res.ok) {
            const msg = await readErrorMessage(res);
            const note = document.getElementById("userNote");
            note.textContent = msg === "USER_NOT_FOUND"
              ? "Usuario no encontrado."
              : `No se pudo reinvitar (${msg}).`;
            return;
          }
          const data = await res.json();
          const note = document.getElementById("userNote");
          if (res.ok) {
            const phoneSafe = String(u.phone || "").replace(/\D/g, "");
            const activationLink = buildActivationLink(data.activationUrl);
            const text = `Hola ${u.fullName || ""}, activa tu cuenta aquí: ${activationLink}. Luego ingresa desde tu celular en ${window.location.origin}/executive`;
            const waUrl = phoneSafe
              ? `https://wa.me/${phoneSafe}?text=${encodeURIComponent(text)}`
              : null;
            note.innerHTML = waUrl
              ? `Invitación creada. <a href="${waUrl}" target="_blank">Enviar por WhatsApp</a>`
              : `Invitación creada. Link: ${activationLink}`;
            renderUsers().catch(() => {});
          } else {
            note.textContent = "No se pudo reinvitar.";
          }
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn outline";
        deleteBtn.textContent = "Eliminar";
        deleteBtn.addEventListener("click", async () => {
          if (!confirm("¿Eliminar este usuario?")) return;
          const res = await fetch(`/api/tenant/users/${u.id}`, { method: "DELETE" });
          const note = document.getElementById("userNote");
          if (handleUnauthorized(res)) return;
          if (res.ok) {
            note.textContent = "Usuario eliminado.";
            renderUsers().catch(() => {});
          } else {
            note.textContent = "No se pudo eliminar.";
          }
        });

        action.appendChild(activateBtn);
        action.appendChild(editBtn);
        action.appendChild(reinviteBtn);
        action.appendChild(deleteBtn);

        list.appendChild(fullName);
        list.appendChild(email);
        list.appendChild(phone);
        list.appendChild(role);
        list.appendChild(invited);
        list.appendChild(status);
        list.appendChild(action);

        if (u.role === "TENANT_USER") {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = u.fullName || u.email;
          execSelect.appendChild(opt);
        }
      });
    }

    async function renderInspections() {
      const list = document.getElementById("inspectionList");
      list.innerHTML = "";
      const inspections = await loadInspections();
      if (!inspections.length) {
        list.appendChild(Object.assign(document.createElement("div"), {
          className: "note",
          textContent: "Sin inspecciones aún."
        }));
        return;
      }
      inspections.forEach((c) => {
        const address = document.createElement("div");
        address.textContent = c.address || "Dirección no informada";
        const exec = document.createElement("div");
        exec.textContent = c.assignedUserName || "Sin asignar";
        const type = document.createElement("div");
        type.textContent = `${c.propertyType === "HOUSE" ? "Casa" : "Departamento"} · ${c.bedrooms}D / ${c.bathrooms}B`;
        const status = document.createElement("div");
        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = c.status || "DRAFT";
        status.appendChild(badge);
        const progress = document.createElement("div");
        progress.textContent = `${c.progress?.pct || 0}%`;
        const created = document.createElement("div");
        created.textContent = formatDateShort(c.createdAt);

        list.appendChild(address);
        list.appendChild(exec);
        list.appendChild(type);
        list.appendChild(status);
        list.appendChild(progress);
        list.appendChild(created);
      });
    }

    document.getElementById("saveUserBtn").addEventListener("click", async () => {
      const note = document.getElementById("userNote");
      const fullName = document.getElementById("userFullName").value.trim();
      const email = document.getElementById("userEmail").value.trim();
      const phone = document.getElementById("userPhone").value.trim();
      const role = document.getElementById("userRole").value;
      if (!fullName || !email) {
        note.textContent = "Nombre y email son obligatorios.";
        return;
      }
      const res = await fetch("/api/tenant/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ fullName, email, phone, role, action: "save" })
      });
      if (handleUnauthorized(res)) return;
      if (res.ok) {
        note.textContent = "Usuario guardado sin invitación.";
        document.getElementById("userFullName").value = "";
        document.getElementById("userEmail").value = "";
        document.getElementById("userPhone").value = "";
        document.getElementById("userRole").value = "TENANT_USER";
        renderUsers().catch(() => {});
      } else if (res.status === 409) {
        note.textContent = "El email ya está en uso en otra corredora.";
      } else {
        const msg = await readErrorMessage(res);
        note.textContent = `No se pudo guardar (${msg}).`;
      }
    });

    document.getElementById("inviteUserBtn").addEventListener("click", async () => {
      const note = document.getElementById("userNote");
      const fullName = document.getElementById("userFullName").value.trim();
      const email = document.getElementById("userEmail").value.trim();
      const phone = document.getElementById("userPhone").value.trim();
      const role = document.getElementById("userRole").value;
      if (!fullName || !email) {
        note.textContent = "Nombre y email son obligatorios.";
        return;
      }
      const res = await fetch("/api/tenant/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ fullName, email, phone, role, action: "invite" })
      });
      if (handleUnauthorized(res)) return;
      if (!res.ok) {
        if (res.status === 409) {
          note.textContent = "El email ya está en uso en otra corredora.";
        } else {
          const msg = await readErrorMessage(res);
          note.textContent = `No se pudo invitar (${msg}).`;
        }
        return;
      }
      const data = await res.json();
      if (res.ok) {
        const phoneSafe = phone.replace(/\D/g, "");
        const activationLink = buildActivationLink(data.activationUrl);
        const text = `Hola ${fullName}, activa tu cuenta aquí: ${activationLink}. Luego ingresa desde tu celular en ${window.location.origin}/executive`;
        const waUrl = phoneSafe
          ? `https://wa.me/${phoneSafe}?text=${encodeURIComponent(text)}`
          : null;
        note.innerHTML = waUrl
          ? `Invitación creada. <a href="${waUrl}" target="_blank">Enviar por WhatsApp</a>`
          : `Invitación creada. Link: ${activationLink}`;
        document.getElementById("userFullName").value = "";
        document.getElementById("userEmail").value = "";
        document.getElementById("userPhone").value = "";
        document.getElementById("userRole").value = "TENANT_USER";
        renderUsers().catch(() => {});
      }
    });

    document.getElementById("createCaseBtn").addEventListener("click", async () => {
      const note = document.getElementById("caseNote");
      const comuna = document.getElementById("propertyComuna").value;
      const street = document.getElementById("propertyStreet").value;
      const number = document.getElementById("propertyNumber").value;
      const dept = document.getElementById("propertyDept").value;
      const fullAddress = document.getElementById("propertyAddress").value;
      const addressParts = [
        [street, number].filter(Boolean).join(" "),
        dept ? `Depto ${dept}` : "",
        comuna
      ].filter(Boolean);
      const addressValue = addressParts.length ? addressParts.join(", ") : fullAddress;
      const payload = {
        ownerName: document.getElementById("ownerName").value,
        ownerRut: document.getElementById("ownerRut").value,
        propertyRol: document.getElementById("propertyRol").value,
        propertyAddress: addressValue,
        propertyOperationType: document.getElementById("propertyOperationType").value,
        propertySurface: document.getElementById("propertySurface").value,
        propertyType: document.getElementById("propertyType").value,
        bathroomsCount: Number(document.getElementById("bathroomsCount").value || 1),
        bedroomsCount: Number(document.getElementById("bedroomsCount").value || 0),
        propertyAgeRange: document.getElementById("propertyAgeRange").value || null,
        floorType: document.getElementById("floorType").value,
        yearBuilt: document.getElementById("yearBuilt").value ? Number(document.getElementById("yearBuilt").value) : null,
        hasPatio: document.getElementById("hasPatio").checked,
        hasAttic: document.getElementById("hasAttic").checked,
        hasLaundry: document.getElementById("hasLaundry").checked,
        assignedUserId: document.getElementById("caseExecutive").value || null
      };
      const res = await fetch("/api/tenant/inspections", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (handleUnauthorized(res)) return;
      const data = await res.json();
      if (res.ok) {
        note.innerHTML = `Inspección creada. Link captura: <a href="${data.captureUrl}" target="_blank">${data.captureUrl}</a>`;
        renderInspections().catch(() => {});
      } else {
        note.textContent = "No se pudo crear la inspección.";
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await fetch("/api/tenant/logout", { method: "POST" });
      window.location.href = "/";
    });

    function setActiveSection() {
      const hash = String(window.location.hash || "").replace("#", "");
      const section = hash || "users";
      document.querySelectorAll("[data-section]").forEach((el) => {
        const key = el.getAttribute("data-section");
        el.classList.toggle("hidden", key !== section);
      });
      document.querySelectorAll("[data-section-link]").forEach((el) => {
        const key = el.getAttribute("data-section-link");
        el.classList.toggle("active", key === section);
      });
      if (section === "inspections") {
        renderInspections().catch(() => {});
      }
    }

    const inspectionFormCard = document.getElementById("inspectionFormCard");
    const toggleInspectionFormBtn = document.getElementById("toggleInspectionFormBtn");
    if (inspectionFormCard && toggleInspectionFormBtn) {
      inspectionFormCard.classList.add("hidden");
      inspectionFormCard.style.display = "none";
      const setLabel = () => {
        toggleInspectionFormBtn.textContent = inspectionFormCard.classList.contains("hidden")
          ? "Agregar inspección"
          : "Ocultar formulario";
      };
      setLabel();
      toggleInspectionFormBtn.addEventListener("click", () => {
        const isHidden = inspectionFormCard.classList.contains("hidden");
        inspectionFormCard.classList.toggle("hidden");
        inspectionFormCard.style.display = isHidden ? "" : "none";
        setLabel();
      });
    }

    window.addEventListener("hashchange", setActiveSection);
    setActiveSection();

    loadTenant().then(() => {
      renderUsers().catch(() => {});
      renderInspections().catch(() => {});
    }).catch(() => {});
  </script>
</body>
</html>
