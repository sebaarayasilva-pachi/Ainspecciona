<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin · Ainspecciona</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #F6F7F9;
      color: #0f172a;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
    }
    .nav {
      max-width: none;
      margin: 0;
      padding: 20px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: inherit;
      font-weight: 800;
    }
    .brand img { height: 70px; }
    .links {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: center;
    }
    .links a {
      text-decoration: none;
      color: #1f2937;
      font-weight: 600;
      font-size: 14px;
    }
    .cta {
      padding: 10px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      text-decoration: none;
      font-weight: 800;
      font-size: 14px;
    }
    main {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: calc(100vh - 96px);
    }
    aside {
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
      padding: 24px 18px;
    }
    .asideTitle {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #64748b;
      margin: 0 0 12px;
      font-weight: 700;
    }
    .menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .menu a {
      text-decoration: none;
      color: #0f172a;
      font-weight: 600;
      padding: 10px 12px;
      border-radius: 10px;
    }
    .menu a.active {
      background: #eef2ff;
      color: #1d4ed8;
    }
    .content {
      padding: 28px 28px 80px;
    }
    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
      margin-bottom: 18px;
    }
    h1 { margin: 0 0 8px; font-size: 26px; }
    .muted { color: #64748b; }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    .kpiRows {
      display: grid;
      grid-template-columns: 120px 120px 1fr;
      gap: 10px;
      align-items: center;
    }
    .recRows {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 10px;
      align-items: center;
    }
    .kpiRow { display: contents; }
    .kpiHeader {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }
    .kpiCard {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .kpiTitle {
      margin: 0 0 6px;
      font-size: 18px;
    }
    .kpiSubtle {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 10px;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: 10px;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .row:last-child { border-bottom: none; }
    label { font-weight: 600; font-size: 14px; }
    input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
    }
    textarea {
      width: 100%;
      min-height: 70px;
      resize: vertical;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      font-family: inherit;
    }
    .kpiBlock {
      border-top: 1px solid #f1f5f9;
      padding-top: 12px;
      margin-top: 12px;
    }
    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      border: 1px solid transparent;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
    }
    .btn.outline {
      background: #fff;
      color: #1f2937;
      border-color: #e5e7eb;
    }
    .note {
      font-size: 12px;
      color: #64748b;
      margin-top: 10px;
    }
    .content.hidden {
      display: none;
    }
    .tenantGrid {
      display: grid;
      grid-template-columns: 1.2fr 1.2fr 0.8fr 1fr 1fr 1fr 120px 120px;
      gap: 10px;
      align-items: center;
    }
    .userGrid {
      display: grid;
      grid-template-columns: 1.2fr 1fr 140px 160px 140px 120px 160px;
      gap: 10px;
      align-items: center;
    }
    .slotMapGrid {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 10px 12px;
      align-items: center;
      margin-top: 8px;
    }
    .slotMapHeader {
      font-size: 12px;
      color: #64748b;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .slotMapGrid select {
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
      background: #fff;
    }
    .tenantRow { display: contents; }
    .userRow { display: contents; }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      background: #EEF2FF;
      color: #1D4ED8;
    }
    .smallInput {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }
    .userCard {
      border: 1px dashed #e5e7eb;
      border-radius: 12px;
      padding: 14px;
      margin-top: 10px;
      background: #f8fafc;
    }
    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
      aside { border-right: none; border-bottom: 1px solid #e5e7eb; }
      .grid { grid-template-columns: 1fr; }
      .kpiRows { grid-template-columns: 1fr; }
      .recRows { grid-template-columns: 1fr; }
      .tenantGrid { grid-template-columns: 1fr; }
      .userGrid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <a class="brand" href="/">
        <img src="/assets/Logo Ainspecciona.png" alt="Ainspecciona" />
      </a>
      <div class="links">
        <a href="/dashboard">Dashboard</a>
        <a class="cta" href="/formulario">Generar inspección</a>
      </div>
    </div>
  </header>

  <main>
    <aside>
      <div class="asideTitle">Admin</div>
      <nav class="menu">
        <a class="active" data-section-link="score" href="#score">Score</a>
        <a data-section-link="tenants" href="#tenants">Corredoras</a>
      </nav>
    </aside>

    <section class="content" id="score" data-section="score">
      <h1>Score por KPI</h1>
      <div class="muted">Organiza el score y el mensaje base por cada KPI.</div>

      <div class="card kpiCard">
        <div>
          <h3 class="kpiTitle">Muros y pintura</h3>
          <div class="kpiSubtle">Severidad, puntaje y mensaje base</div>
          <div class="kpiRows">
            <div class="kpiHeader">Severidad</div>
            <div class="kpiHeader">Puntaje</div>
            <div class="kpiHeader">Mensaje base</div>
            <div class="kpiRow">
              <label>Bajo</label>
              <input id="kpiMurosPinturaLow" type="number" step="1" min="0" />
              <textarea id="msgMurosPinturaLow"></textarea>
            </div>
            <div class="kpiRow">
              <label>Medio</label>
              <input id="kpiMurosPinturaMed" type="number" step="1" min="0" />
              <textarea id="msgMurosPinturaMed"></textarea>
            </div>
            <div class="kpiRow">
              <label>Alto</label>
              <input id="kpiMurosPinturaHigh" type="number" step="1" min="0" />
              <textarea id="msgMurosPinturaHigh"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card kpiCard">
        <div>
          <h3 class="kpiTitle">Humedad visible</h3>
          <div class="kpiSubtle">Severidad, puntaje y mensaje base</div>
          <div class="kpiRows">
            <div class="kpiHeader">Severidad</div>
            <div class="kpiHeader">Puntaje</div>
            <div class="kpiHeader">Mensaje base</div>
            <div class="kpiRow">
              <label>Bajo</label>
              <input id="kpiHumedadLow" type="number" step="1" min="0" />
              <textarea id="msgHumedadLow"></textarea>
            </div>
            <div class="kpiRow">
              <label>Medio</label>
              <input id="kpiHumedadMed" type="number" step="1" min="0" />
              <textarea id="msgHumedadMed"></textarea>
            </div>
            <div class="kpiRow">
              <label>Alto</label>
              <input id="kpiHumedadHigh" type="number" step="1" min="0" />
              <textarea id="msgHumedadHigh"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card kpiCard">
        <div>
          <h3 class="kpiTitle">Pisos</h3>
          <div class="kpiSubtle">Severidad, puntaje y mensaje base</div>
          <div class="kpiRows">
            <div class="kpiHeader">Severidad</div>
            <div class="kpiHeader">Puntaje</div>
            <div class="kpiHeader">Mensaje base</div>
            <div class="kpiRow">
              <label>Bajo</label>
              <input id="kpiPisosLow" type="number" step="1" min="0" />
              <textarea id="msgPisosLow"></textarea>
            </div>
            <div class="kpiRow">
              <label>Medio</label>
              <input id="kpiPisosMed" type="number" step="1" min="0" />
              <textarea id="msgPisosMed"></textarea>
            </div>
            <div class="kpiRow">
              <label>Alto</label>
              <input id="kpiPisosHigh" type="number" step="1" min="0" />
              <textarea id="msgPisosHigh"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card kpiCard">
        <div>
          <h3 class="kpiTitle">Sanitarios</h3>
          <div class="kpiSubtle">Severidad, puntaje y mensaje base</div>
          <div class="kpiRows">
            <div class="kpiHeader">Severidad</div>
            <div class="kpiHeader">Puntaje</div>
            <div class="kpiHeader">Mensaje base</div>
            <div class="kpiRow">
              <label>Bajo</label>
              <input id="kpiSanitariosLow" type="number" step="1" min="0" />
              <textarea id="msgSanitariosLow"></textarea>
            </div>
            <div class="kpiRow">
              <label>Medio</label>
              <input id="kpiSanitariosMed" type="number" step="1" min="0" />
              <textarea id="msgSanitariosMed"></textarea>
            </div>
            <div class="kpiRow">
              <label>Alto</label>
              <input id="kpiSanitariosHigh" type="number" step="1" min="0" />
              <textarea id="msgSanitariosHigh"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card kpiCard">
        <div>
          <h3 class="kpiTitle">Electricidad visible</h3>
          <div class="kpiSubtle">Severidad, puntaje y mensaje base</div>
          <div class="kpiRows">
            <div class="kpiHeader">Severidad</div>
            <div class="kpiHeader">Puntaje</div>
            <div class="kpiHeader">Mensaje base</div>
            <div class="kpiRow">
              <label>Bajo</label>
              <input id="kpiElectricidadLow" type="number" step="1" min="0" />
              <textarea id="msgElectricidadLow"></textarea>
            </div>
            <div class="kpiRow">
              <label>Medio</label>
              <input id="kpiElectricidadMed" type="number" step="1" min="0" />
              <textarea id="msgElectricidadMed"></textarea>
            </div>
            <div class="kpiRow">
              <label>Alto</label>
              <input id="kpiElectricidadHigh" type="number" step="1" min="0" />
              <textarea id="msgElectricidadHigh"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card kpiCard">
        <div>
          <h3 class="kpiTitle">Ventanas y cerramientos</h3>
          <div class="kpiSubtle">Severidad, puntaje y mensaje base</div>
          <div class="kpiRows">
            <div class="kpiHeader">Severidad</div>
            <div class="kpiHeader">Puntaje</div>
            <div class="kpiHeader">Mensaje base</div>
            <div class="kpiRow">
              <label>Bajo</label>
              <input id="kpiVentanasCerramientosLow" type="number" step="1" min="0" />
              <textarea id="msgVentanasCerramientosLow"></textarea>
            </div>
            <div class="kpiRow">
              <label>Medio</label>
              <input id="kpiVentanasCerramientosMed" type="number" step="1" min="0" />
              <textarea id="msgVentanasCerramientosMed"></textarea>
            </div>
            <div class="kpiRow">
              <label>Alto</label>
              <input id="kpiVentanasCerramientosHigh" type="number" step="1" min="0" />
              <textarea id="msgVentanasCerramientosHigh"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card kpiCard">
        <div>
          <h3 class="kpiTitle">Puertas y herrajes</h3>
          <div class="kpiSubtle">Severidad, puntaje y mensaje base</div>
          <div class="kpiRows">
            <div class="kpiHeader">Severidad</div>
            <div class="kpiHeader">Puntaje</div>
            <div class="kpiHeader">Mensaje base</div>
            <div class="kpiRow">
              <label>Bajo</label>
              <input id="kpiPuertasHerrajesLow" type="number" step="1" min="0" />
              <textarea id="msgPuertasHerrajesLow"></textarea>
            </div>
            <div class="kpiRow">
              <label>Medio</label>
              <input id="kpiPuertasHerrajesMed" type="number" step="1" min="0" />
              <textarea id="msgPuertasHerrajesMed"></textarea>
            </div>
            <div class="kpiRow">
              <label>Alto</label>
              <input id="kpiPuertasHerrajesHigh" type="number" step="1" min="0" />
              <textarea id="msgPuertasHerrajesHigh"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card kpiCard">
        <div>
          <h3 class="kpiTitle">Mobiliario fijo (cocina y closets)</h3>
          <div class="kpiSubtle">Severidad, puntaje y mensaje base</div>
          <div class="kpiRows">
            <div class="kpiHeader">Severidad</div>
            <div class="kpiHeader">Puntaje</div>
            <div class="kpiHeader">Mensaje base</div>
            <div class="kpiRow">
              <label>Bajo</label>
              <input id="kpiMobiliarioFijoLow" type="number" step="1" min="0" />
              <textarea id="msgMobiliarioFijoLow"></textarea>
            </div>
            <div class="kpiRow">
              <label>Medio</label>
              <input id="kpiMobiliarioFijoMed" type="number" step="1" min="0" />
              <textarea id="msgMobiliarioFijoMed"></textarea>
            </div>
            <div class="kpiRow">
              <label>Alto</label>
              <input id="kpiMobiliarioFijoHigh" type="number" step="1" min="0" />
              <textarea id="msgMobiliarioFijoHigh"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Mapa de slots a KPI</h3>
        <div class="kpiSubtle">Define el KPI de cada slot de captura.</div>
        <div class="slotMapGrid" id="slotMapGrid"></div>
      </div>

      <div class="card">
        <h3>Rangos de badge</h3>
        <div class="row">
          <label for="badgeYellow">Amarillo desde</label>
          <input id="badgeYellow" type="number" step="1" min="0" max="100" />
        </div>
        <div class="row">
          <label for="badgeGreen">Verde desde</label>
          <input id="badgeGreen" type="number" step="1" min="0" max="100" />
        </div>
      </div>


      <div class="card">
        <h3>Recomendación por badge</h3>
        <div class="kpiSubtle">Badge y recomendación</div>
        <div class="recRows">
          <div class="kpiHeader">Badge</div>
          <div class="kpiHeader">Mensaje</div>
          <div class="kpiRow">
            <label for="recGreen">Verde</label>
            <textarea id="recGreen"></textarea>
          </div>
          <div class="kpiRow">
            <label for="recYellow">Amarillo</label>
            <textarea id="recYellow"></textarea>
          </div>
          <div class="kpiRow">
            <label for="recRed">Rojo</label>
            <textarea id="recRed"></textarea>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="saveBtn" type="button">Guardar cambios</button>
        <button class="btn outline" id="resetBtn" type="button">Restaurar valores</button>
      </div>
      <div class="note">Los cambios se guardan en este navegador (local). Luego podemos conectarlo al backend.</div>
    </section>

    <section class="content" id="tenants" data-section="tenants">
      <h1>Corredoras</h1>
      <div class="muted">Mantenedor de corredoras (tenant) y datos de contacto.</div>

      <div class="card">
        <h3>Crear corredora</h3>
        <div class="grid">
          <div class="row">
            <label for="tenantName">Nombre</label>
            <input id="tenantName" type="text" class="smallInput" />
          </div>
          <div class="row">
            <label for="tenantLegalName">Razón social</label>
            <input id="tenantLegalName" type="text" class="smallInput" />
          </div>
          <div class="row">
            <label for="tenantRut">RUT</label>
            <input id="tenantRut" type="text" class="smallInput" />
          </div>
          <div class="row">
            <label for="tenantPassword">Clave</label>
            <input id="tenantPassword" type="password" class="smallInput" />
          </div>
          <div class="row">
            <label for="tenantEmail">Email</label>
            <input id="tenantEmail" type="email" class="smallInput" />
          </div>
          <div class="row">
            <label for="tenantPhone">Teléfono</label>
            <input id="tenantPhone" type="text" class="smallInput" />
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="createTenantBtn" type="button">Crear corredora</button>
        </div>
      </div>

      <div class="card">
        <h3>Listado de corredoras</h3>
        <div class="kpiSubtle">Edita nombre, razón social, RUT, contacto y estado.</div>
        <div id="tenantNote" class="note"></div>
        <div id="tenantsEmpty" class="note">Aún no hay corredoras registradas.</div>
        <div class="tenantGrid" id="tenantsTable"></div>
        <div id="tenantUsersWrap"></div>
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = "ainspectaScoreConfig";
    const defaultConfig = {
      kpis: {
        MUROS_PINTURA: { low: 5, medium: 15, high: 30 },
        HUMEDAD: { low: 5, medium: 15, high: 30 },
        PISOS: { low: 5, medium: 15, high: 30 },
        SANITARIOS: { low: 5, medium: 15, high: 30 },
        ELECTRICIDAD: { low: 5, medium: 15, high: 30 },
        VENTANAS_CERRAMIENTOS: { low: 5, medium: 15, high: 30 },
        PUERTAS_HERRAJES: { low: 5, medium: 15, high: 30 },
        MOBILIARIO_FIJO: { low: 5, medium: 15, high: 30 }
      },
      slotKpiMap: {
        BATHROOM_1_SHOWER: "SANITARIOS",
        BATHROOM_1_SINK: "SANITARIOS",
        BATHROOM_1_SINK_PIPES: "SANITARIOS",
        BATHROOM_1_WC: "SANITARIOS",
        BATHROOM_1_WC_PIPES: "SANITARIOS",
        BATHROOM_1_CEILING: "HUMEDAD",
        BATHROOM_1_OUTLETS: "ELECTRICIDAD",
        BATHROOM_2_SHOWER: "SANITARIOS",
        BATHROOM_2_SINK: "SANITARIOS",
        BATHROOM_2_SINK_PIPES: "SANITARIOS",
        BATHROOM_2_WC: "SANITARIOS",
        BATHROOM_2_WC_PIPES: "SANITARIOS",
        BATHROOM_2_CEILING: "HUMEDAD",
        BATHROOM_2_OUTLETS: "ELECTRICIDAD",
        KITCHEN_UNDER_SINK: "HUMEDAD",
        KITCHEN_SINK_WALL: "HUMEDAD",
        KITCHEN_COUNTERTOP: "MOBILIARIO_FIJO",
        KITCHEN_CABINETS: "MOBILIARIO_FIJO",
        KITCHEN_OUTLETS: "ELECTRICIDAD",
        KITCHEN_WINDOW: "VENTANAS_CERRAMIENTOS",
        LIVING_WALLS: "MUROS_PINTURA",
        LIVING_CEILING: "MUROS_PINTURA",
        LIVING_FLOOR: "PISOS",
        LIVING_WINDOWS: "VENTANAS_CERRAMIENTOS",
        LIVING_SWITCHES: "ELECTRICIDAD",
        BEDROOM_1_WALLS: "MUROS_PINTURA",
        BEDROOM_1_FLOOR: "PISOS",
        BEDROOM_1_CLOSET: "MOBILIARIO_FIJO",
        BEDROOM_1_WINDOWS: "VENTANAS_CERRAMIENTOS",
        BEDROOM_2_WALLS: "MUROS_PINTURA",
        BEDROOM_2_FLOOR: "PISOS",
        BEDROOM_2_CLOSET: "MOBILIARIO_FIJO",
        BEDROOM_2_WINDOWS: "VENTANAS_CERRAMIENTOS",
        BEDROOM_3_WALLS: "MUROS_PINTURA",
        BEDROOM_3_FLOOR: "PISOS",
        BEDROOM_3_CLOSET: "MOBILIARIO_FIJO",
        BEDROOM_3_WINDOWS: "VENTANAS_CERRAMIENTOS",
        LAUNDRY_WALLS_FLOOR: "HUMEDAD",
        ELECTRICAL_PANEL: "ELECTRICIDAD"
      },
      messages: {
        MUROS_PINTURA: {
          low: "Se observan imperfecciones menores en muros o pintura del área inspeccionada.",
          medium: "Se observan deterioros visibles en muros o pintura del área inspeccionada.",
          high: "Se observan deterioros relevantes en muros o pintura del área inspeccionada."
        },
        HUMEDAD: {
          low: "Se observan indicios leves de humedad superficial en el área inspeccionada.",
          medium: "Se observan señales visibles de humedad en el área inspeccionada.",
          high: "Se observan evidencias visibles de humedad extendida en el área inspeccionada."
        },
        PISOS: {
          low: "Se observan marcas o desgaste leve en el piso del área inspeccionada.",
          medium: "Se observan desgaste o daños visibles en el piso del área inspeccionada.",
          high: "Se observan daños visibles relevantes en el piso del área inspeccionada."
        },
        SANITARIOS: {
          low: "Se observan condiciones visibles menores en artefactos sanitarios del área inspeccionada.",
          medium: "Se observan condiciones visibles en artefactos sanitarios del área inspeccionada.",
          high: "Se observan condiciones visibles relevantes en artefactos sanitarios del área inspeccionada."
        },
        ELECTRICIDAD: {
          low: "Se observan condiciones visibles menores en elementos eléctricos del área inspeccionada.",
          medium: "Se observan condiciones visibles en elementos eléctricos del área inspeccionada.",
          high: "Se observan condiciones visibles relevantes en elementos eléctricos del área inspeccionada."
        },
        VENTANAS_CERRAMIENTOS: {
          low: "Se observan condiciones visibles menores en ventanas o cerramientos del área inspeccionada.",
          medium: "Se observan condiciones visibles en ventanas o cerramientos del área inspeccionada.",
          high: "Se observan condiciones visibles relevantes en ventanas o cerramientos del área inspeccionada."
        },
        PUERTAS_HERRAJES: {
          low: "Se observan condiciones visibles menores en puertas o herrajes del área inspeccionada.",
          medium: "Se observan condiciones visibles en puertas o herrajes del área inspeccionada.",
          high: "Se observan condiciones visibles relevantes en puertas o herrajes del área inspeccionada."
        },
        MOBILIARIO_FIJO: {
          low: "Se observan condiciones visibles menores en mobiliario fijo del área inspeccionada.",
          medium: "Se observan condiciones visibles en mobiliario fijo del área inspeccionada.",
          high: "Se observan condiciones visibles relevantes en mobiliario fijo del área inspeccionada."
        }
      },
      recommendations: {
        GREEN: "Se recomienda mantener seguimiento y control preventivo.",
        YELLOW: "Se recomienda revisar y monitorear el estado observado.",
        RED: "Se recomienda una revisión técnica detallada del hallazgo."
      },
      badge: { yellowFrom: 60, greenFrom: 85 }
    };

    const fields = [
      { id: "kpiMurosPinturaLow", path: "kpis.MUROS_PINTURA.low", type: "number" },
      { id: "kpiMurosPinturaMed", path: "kpis.MUROS_PINTURA.medium", type: "number" },
      { id: "kpiMurosPinturaHigh", path: "kpis.MUROS_PINTURA.high", type: "number" },
      { id: "kpiHumedadLow", path: "kpis.HUMEDAD.low", type: "number" },
      { id: "kpiHumedadMed", path: "kpis.HUMEDAD.medium", type: "number" },
      { id: "kpiHumedadHigh", path: "kpis.HUMEDAD.high", type: "number" },
      { id: "kpiPisosLow", path: "kpis.PISOS.low", type: "number" },
      { id: "kpiPisosMed", path: "kpis.PISOS.medium", type: "number" },
      { id: "kpiPisosHigh", path: "kpis.PISOS.high", type: "number" },
      { id: "kpiSanitariosLow", path: "kpis.SANITARIOS.low", type: "number" },
      { id: "kpiSanitariosMed", path: "kpis.SANITARIOS.medium", type: "number" },
      { id: "kpiSanitariosHigh", path: "kpis.SANITARIOS.high", type: "number" },
      { id: "kpiElectricidadLow", path: "kpis.ELECTRICIDAD.low", type: "number" },
      { id: "kpiElectricidadMed", path: "kpis.ELECTRICIDAD.medium", type: "number" },
      { id: "kpiElectricidadHigh", path: "kpis.ELECTRICIDAD.high", type: "number" },
      { id: "kpiVentanasCerramientosLow", path: "kpis.VENTANAS_CERRAMIENTOS.low", type: "number" },
      { id: "kpiVentanasCerramientosMed", path: "kpis.VENTANAS_CERRAMIENTOS.medium", type: "number" },
      { id: "kpiVentanasCerramientosHigh", path: "kpis.VENTANAS_CERRAMIENTOS.high", type: "number" },
      { id: "kpiPuertasHerrajesLow", path: "kpis.PUERTAS_HERRAJES.low", type: "number" },
      { id: "kpiPuertasHerrajesMed", path: "kpis.PUERTAS_HERRAJES.medium", type: "number" },
      { id: "kpiPuertasHerrajesHigh", path: "kpis.PUERTAS_HERRAJES.high", type: "number" },
      { id: "kpiMobiliarioFijoLow", path: "kpis.MOBILIARIO_FIJO.low", type: "number" },
      { id: "kpiMobiliarioFijoMed", path: "kpis.MOBILIARIO_FIJO.medium", type: "number" },
      { id: "kpiMobiliarioFijoHigh", path: "kpis.MOBILIARIO_FIJO.high", type: "number" },
      { id: "badgeYellow", path: "badge.yellowFrom", type: "number" },
      { id: "badgeGreen", path: "badge.greenFrom", type: "number" },
      { id: "msgMurosPinturaLow", path: "messages.MUROS_PINTURA.low", type: "text" },
      { id: "msgMurosPinturaMed", path: "messages.MUROS_PINTURA.medium", type: "text" },
      { id: "msgMurosPinturaHigh", path: "messages.MUROS_PINTURA.high", type: "text" },
      { id: "msgHumedadLow", path: "messages.HUMEDAD.low", type: "text" },
      { id: "msgHumedadMed", path: "messages.HUMEDAD.medium", type: "text" },
      { id: "msgHumedadHigh", path: "messages.HUMEDAD.high", type: "text" },
      { id: "msgPisosLow", path: "messages.PISOS.low", type: "text" },
      { id: "msgPisosMed", path: "messages.PISOS.medium", type: "text" },
      { id: "msgPisosHigh", path: "messages.PISOS.high", type: "text" },
      { id: "msgSanitariosLow", path: "messages.SANITARIOS.low", type: "text" },
      { id: "msgSanitariosMed", path: "messages.SANITARIOS.medium", type: "text" },
      { id: "msgSanitariosHigh", path: "messages.SANITARIOS.high", type: "text" },
      { id: "msgElectricidadLow", path: "messages.ELECTRICIDAD.low", type: "text" },
      { id: "msgElectricidadMed", path: "messages.ELECTRICIDAD.medium", type: "text" },
      { id: "msgElectricidadHigh", path: "messages.ELECTRICIDAD.high", type: "text" },
      { id: "msgVentanasCerramientosLow", path: "messages.VENTANAS_CERRAMIENTOS.low", type: "text" },
      { id: "msgVentanasCerramientosMed", path: "messages.VENTANAS_CERRAMIENTOS.medium", type: "text" },
      { id: "msgVentanasCerramientosHigh", path: "messages.VENTANAS_CERRAMIENTOS.high", type: "text" },
      { id: "msgPuertasHerrajesLow", path: "messages.PUERTAS_HERRAJES.low", type: "text" },
      { id: "msgPuertasHerrajesMed", path: "messages.PUERTAS_HERRAJES.medium", type: "text" },
      { id: "msgPuertasHerrajesHigh", path: "messages.PUERTAS_HERRAJES.high", type: "text" },
      { id: "msgMobiliarioFijoLow", path: "messages.MOBILIARIO_FIJO.low", type: "text" },
      { id: "msgMobiliarioFijoMed", path: "messages.MOBILIARIO_FIJO.medium", type: "text" },
      { id: "msgMobiliarioFijoHigh", path: "messages.MOBILIARIO_FIJO.high", type: "text" },
      { id: "recGreen", path: "recommendations.GREEN", type: "text" },
      { id: "recYellow", path: "recommendations.YELLOW", type: "text" },
      { id: "recRed", path: "recommendations.RED", type: "text" }
    ];

    const KPI_OPTIONS = [
      { value: "", label: "Sin KPI" },
      { value: "MUROS_PINTURA", label: "Muros y pintura" },
      { value: "HUMEDAD", label: "Humedad visible" },
      { value: "PISOS", label: "Pisos" },
      { value: "SANITARIOS", label: "Sanitarios" },
      { value: "ELECTRICIDAD", label: "Electricidad visible" },
      { value: "VENTANAS_CERRAMIENTOS", label: "Ventanas y cerramientos" },
      { value: "PUERTAS_HERRAJES", label: "Puertas y herrajes" },
      { value: "MOBILIARIO_FIJO", label: "Mobiliario fijo" }
    ];

    const SLOT_CODES = [
      "BATHROOM_1_SHOWER",
      "BATHROOM_1_SINK",
      "BATHROOM_1_SINK_PIPES",
      "BATHROOM_1_WC",
      "BATHROOM_1_WC_PIPES",
      "BATHROOM_1_CEILING",
      "BATHROOM_1_OUTLETS",
      "BATHROOM_2_SHOWER",
      "BATHROOM_2_SINK",
      "BATHROOM_2_SINK_PIPES",
      "BATHROOM_2_WC",
      "BATHROOM_2_WC_PIPES",
      "BATHROOM_2_CEILING",
      "BATHROOM_2_OUTLETS",
      "KITCHEN_UNDER_SINK",
      "KITCHEN_SINK_WALL",
      "KITCHEN_COUNTERTOP",
      "KITCHEN_CABINETS",
      "KITCHEN_OUTLETS",
      "KITCHEN_WINDOW",
      "LIVING_WALLS",
      "LIVING_CEILING",
      "LIVING_FLOOR",
      "LIVING_WINDOWS",
      "LIVING_SWITCHES",
      "BEDROOM_1_WALLS",
      "BEDROOM_1_FLOOR",
      "BEDROOM_1_CLOSET",
      "BEDROOM_1_WINDOWS",
      "BEDROOM_2_WALLS",
      "BEDROOM_2_FLOOR",
      "BEDROOM_2_CLOSET",
      "BEDROOM_2_WINDOWS",
      "BEDROOM_3_WALLS",
      "BEDROOM_3_FLOOR",
      "BEDROOM_3_CLOSET",
      "BEDROOM_3_WINDOWS",
      "LAUNDRY_WALLS_FLOOR",
      "ELECTRICAL_PANEL"
    ];

    function normalizeConfig(input) {
      const next = JSON.parse(JSON.stringify(defaultConfig));
      if (!input || typeof input !== "object") return next;
      if (input.kpis) {
        Object.keys(next.kpis).forEach((key) => {
          const src = input.kpis[key] || {};
          next.kpis[key] = {
            low: Number.isFinite(src.low) ? src.low : next.kpis[key].low,
            medium: Number.isFinite(src.medium) ? src.medium : next.kpis[key].medium,
            high: Number.isFinite(src.high) ? src.high : next.kpis[key].high
          };
        });
      }
      if (input.slotKpiMap && typeof input.slotKpiMap === "object") {
        next.slotKpiMap = {
          ...next.slotKpiMap,
          ...Object.fromEntries(Object.entries(input.slotKpiMap).map(([k, v]) => [String(k).toUpperCase(), String(v || "").toUpperCase()]))
        };
      }
      if (input.messages) {
        Object.keys(next.messages).forEach((key) => {
          const src = input.messages[key] || {};
          next.messages[key] = {
            low: src.low || next.messages[key].low,
            medium: src.medium || next.messages[key].medium,
            high: src.high || next.messages[key].high
          };
        });
      }
      if (input.recommendations) {
        next.recommendations = {
          GREEN: input.recommendations.GREEN || next.recommendations.GREEN,
          YELLOW: input.recommendations.YELLOW || next.recommendations.YELLOW,
          RED: input.recommendations.RED || next.recommendations.RED
        };
      }
      if (input.badge) {
        next.badge = {
          yellowFrom: Number.isFinite(input.badge.yellowFrom) ? input.badge.yellowFrom : next.badge.yellowFrom,
          greenFrom: Number.isFinite(input.badge.greenFrom) ? input.badge.greenFrom : next.badge.greenFrom
        };
      }
      return next;
    }

    async function fetchConfig() {
      try {
        const res = await fetch("/api/admin/score-config");
        const data = await res.json();
        if (res.ok && data?.config?.kpis) {
          const normalized = normalizeConfig(data.config);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
          return normalized;
        }
      } catch {}
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return normalizeConfig(null);
      try {
        const parsed = JSON.parse(raw);
        if (!parsed?.kpis) return normalizeConfig(null);
        return normalizeConfig(parsed);
      } catch {
        return normalizeConfig(null);
      }
    }

    function setLocalConfig(cfg) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
    }

    function getByPath(obj, path) {
      return path.split(".").reduce((acc, key) => acc?.[key], obj);
    }

    function setByPath(obj, path, value) {
      const keys = path.split(".");
      let ref = obj;
      keys.slice(0, -1).forEach((k) => {
        if (!ref[k]) ref[k] = {};
        ref = ref[k];
      });
      ref[keys[keys.length - 1]] = value;
    }

    function renderSlotMap(cfg) {
      const grid = document.getElementById("slotMapGrid");
      if (!grid) return;
      grid.innerHTML = "";
      grid.appendChild(Object.assign(document.createElement("div"), { className: "slotMapHeader", textContent: "Slot" }));
      grid.appendChild(Object.assign(document.createElement("div"), { className: "slotMapHeader", textContent: "KPI" }));

      const map = cfg?.slotKpiMap || {};
      SLOT_CODES.forEach((slotCode) => {
        const label = document.createElement("div");
        label.textContent = slotCode;

        const select = document.createElement("select");
        select.setAttribute("data-slot-code", slotCode);
        KPI_OPTIONS.forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt.value;
          option.textContent = opt.label;
          if (String(map[slotCode] || "").toUpperCase() === opt.value) {
            option.selected = true;
          }
          select.appendChild(option);
        });

        grid.appendChild(label);
        grid.appendChild(select);
      });
    }

    async function loadForm() {
      const cfg = await fetchConfig();
      fields.forEach(({ id, path }) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = getByPath(cfg, path);
      });
      renderSlotMap(cfg);
    }

    async function saveForm() {
      const cfg = await fetchConfig();
      fields.forEach(({ id, path, type }) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (type === "number") {
          const val = Number(el.value);
          setByPath(cfg, path, Number.isFinite(val) ? val : getByPath(defaultConfig, path));
        } else {
          const val = String(el.value || "").trim();
          setByPath(cfg, path, val || getByPath(defaultConfig, path));
        }
      });
      const slotMap = {};
      document.querySelectorAll("#slotMapGrid select").forEach((el) => {
        const slotCode = el.getAttribute("data-slot-code");
        const value = String(el.value || "").toUpperCase();
        if (slotCode && value) slotMap[slotCode] = value;
      });
      cfg.slotKpiMap = slotMap;
      setLocalConfig(cfg);
      try {
        const res = await fetch("/api/admin/score-config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ config: cfg })
        });
        if (res.ok) {
          alert("Cambios guardados.");
          return;
        }
      } catch {}
      alert("Cambios guardados localmente.");
    }

    async function resetForm() {
      const reset = JSON.parse(JSON.stringify(defaultConfig));
      setLocalConfig(reset);
      try {
        await fetch("/api/admin/score-config", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ config: reset })
        });
      } catch {}
      await loadForm();
    }

    document.getElementById("saveBtn").addEventListener("click", () => saveForm());
    document.getElementById("resetBtn").addEventListener("click", () => resetForm());
    loadForm().catch(() => {});

    async function fetchTenants() {
      const res = await fetch("/api/admin/tenants");
      const data = await res.json();
      return data?.tenants || [];
    }

    async function fetchTenantUsers(tenantId) {
      const res = await fetch(`/api/admin/tenants/${tenantId}/users`);
      const data = await res.json();
      return data?.users || [];
    }

    function formatDateShort(value) {
      if (!value) return "—";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return "—";
      return new Intl.DateTimeFormat("es-CL", { dateStyle: "medium" }).format(d);
    }

    function buildActivationLink(activationUrl) {
      if (!activationUrl) return `${window.location.origin}/activate`;
      return `${window.location.origin}${activationUrl}`;
    }

    function renderTenants(list) {
      const container = document.getElementById("tenantsTable");
      const empty = document.getElementById("tenantsEmpty");
      const usersWrap = document.getElementById("tenantUsersWrap");
      container.innerHTML = "";
      usersWrap.innerHTML = "";
      if (!list.length) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      container.appendChild(Object.assign(document.createElement("div"), { className: "kpiHeader", textContent: "Corredora" }));
      container.appendChild(Object.assign(document.createElement("div"), { className: "kpiHeader", textContent: "Razón social" }));
      container.appendChild(Object.assign(document.createElement("div"), { className: "kpiHeader", textContent: "RUT" }));
      container.appendChild(Object.assign(document.createElement("div"), { className: "kpiHeader", textContent: "Clave" }));
      container.appendChild(Object.assign(document.createElement("div"), { className: "kpiHeader", textContent: "Email" }));
      container.appendChild(Object.assign(document.createElement("div"), { className: "kpiHeader", textContent: "Teléfono" }));
      container.appendChild(Object.assign(document.createElement("div"), { className: "kpiHeader", textContent: "Estado" }));
      container.appendChild(Object.assign(document.createElement("div"), { className: "kpiHeader", textContent: "Acciones" }));

      list.forEach((t) => {
        const name = document.createElement("input");
        name.value = t.name || "";
        name.className = "smallInput";

        const email = document.createElement("input");
        email.value = t.email || "";
        email.className = "smallInput";

        const phone = document.createElement("input");
        phone.value = t.phone || "";
        phone.className = "smallInput";

        const legalName = document.createElement("input");
        legalName.value = t.legalName || "";
        legalName.className = "smallInput";

        const rut = document.createElement("input");
        rut.value = t.rut || "";
        rut.className = "smallInput";

        const password = document.createElement("input");
        password.type = "password";
        password.placeholder = "Nueva clave";
        password.className = "smallInput";
        const passNote = document.createElement("div");
        passNote.className = "note";
        passNote.textContent = t.passwordSet ? "Clave configurada." : "Clave pendiente.";

        const status = document.createElement("select");
        status.className = "smallInput";
        ["ACTIVE", "INACTIVE"].forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s === "ACTIVE" ? "Activa" : "Inactiva";
          if (String(t.status || "ACTIVE") === s) opt.selected = true;
          status.appendChild(opt);
        });

        const btn = document.createElement("button");
        btn.className = "btn outline";
        btn.type = "button";
        btn.textContent = "Guardar";
        btn.addEventListener("click", async () => {
          const res = await fetch(`/api/admin/tenants/${t.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: name.value,
              legalName: legalName.value,
              rut: rut.value,
              password: password.value || undefined,
              email: email.value,
              phone: phone.value,
              status: status.value
            })
          });
          const note = document.getElementById("tenantNote");
          if (res.ok) {
            note.textContent = password.value
              ? "Corredora guardada y clave actualizada."
              : "Corredora guardada.";
          } else {
            note.textContent = "No se pudo guardar la corredora.";
          }
          password.value = "";
          loadTenants().catch(() => {});
        });

        const nameWrap = document.createElement("div");
        nameWrap.style.display = "grid";
        nameWrap.style.gap = "6px";
        nameWrap.appendChild(name);
        const idBadge = document.createElement("div");
        idBadge.className = "badge";
        idBadge.textContent = `ID: ${t.id.slice(0, 8)}...`;
        idBadge.title = t.id;
        nameWrap.appendChild(idBadge);
        const date = document.createElement("div");
        date.className = "note";
        date.textContent = `Creada: ${formatDateShort(t.createdAt)}`;
        nameWrap.appendChild(date);

        container.appendChild(nameWrap);
        container.appendChild(legalName);
        container.appendChild(rut);
        const passWrap = document.createElement("div");
        passWrap.style.display = "grid";
        passWrap.style.gap = "6px";
        passWrap.appendChild(password);
        passWrap.appendChild(passNote);
        container.appendChild(passWrap);
        container.appendChild(email);
        container.appendChild(phone);
        container.appendChild(status);
        container.appendChild(btn);

        const userCard = document.createElement("div");
        userCard.className = "userCard";
        userCard.innerHTML = `
          <div class="kpiSubtle">Usuarios (${t.name})</div>
          <div class="userGrid" data-users-header>
            <div class="kpiHeader">Nombre</div>
            <div class="kpiHeader">Email</div>
            <div class="kpiHeader">Teléfono</div>
            <div class="kpiHeader">Rol</div>
            <div class="kpiHeader">Invitación</div>
            <div class="kpiHeader">Estado</div>
            <div class="kpiHeader">Acción</div>
          </div>
          <div class="userGrid" data-users-body></div>
          <div class="row" style="margin-top: 10px;">
            <label>Nuevo usuario</label>
            <div></div>
          </div>
          <div class="userGrid" data-users-create>
            <input type="text" class="smallInput" placeholder="Nombre completo" />
            <input type="email" class="smallInput" placeholder="correo@empresa.com" />
            <input type="text" class="smallInput" placeholder="+569..." />
            <select class="smallInput">
              <option value="TENANT_ADMIN">Admin</option>
              <option value="TENANT_USER" selected>Ejecutivo</option>
            </select>
            <div class="badge">—</div>
            <div class="badge">PENDIENTE</div>
            <div style="display:flex; gap:8px;">
              <button class="btn outline" data-action="save">Guardar</button>
              <button class="btn" data-action="invite">Invitar</button>
            </div>
          </div>
          <div class="note" data-users-note></div>
        `;
        usersWrap.appendChild(userCard);

        const body = userCard.querySelector("[data-users-body]");
        const note = userCard.querySelector("[data-users-note]");
        const createInputs = userCard.querySelectorAll("[data-users-create] input, [data-users-create] select");
        const actionButtons = userCard.querySelectorAll("[data-users-create] button");
        const nameInput = createInputs[0];
        const emailInput = createInputs[1];
        const phoneInput = createInputs[2];
        const roleSelect = createInputs[3];

        actionButtons.forEach((btn) => btn.addEventListener("click", async () => {
          const action = btn.getAttribute("data-action") || "invite";
          const fullName = nameInput.value.trim();
          const emailVal = emailInput.value.trim();
          const phone = phoneInput.value.trim();
          const role = roleSelect.value;
          if (!fullName || !emailVal) {
            note.textContent = "Nombre y email son obligatorios.";
            return;
          }
          const res = await fetch(`/api/admin/tenants/${t.id}/users`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ fullName, email: emailVal, phone, role, action })
          });
          const data = await res.json();
          if (res.ok) {
            if (action === "invite") {
              const phoneSafe = phone.replace(/\D/g, "");
              const activationLink = buildActivationLink(data.activationUrl);
              const text = `Hola ${fullName}, activa tu cuenta aquí: ${activationLink}. Luego ingresa desde tu celular en ${window.location.origin}/executive`;
              const waUrl = phoneSafe
                ? `https://wa.me/${phoneSafe}?text=${encodeURIComponent(text)}`
                : null;
              note.innerHTML = waUrl
                ? `Invitación creada. <a href="${waUrl}" target="_blank">Enviar por WhatsApp</a>`
                : `Invitación creada. Link: ${activationLink}`;
            } else {
              note.textContent = "Usuario guardado sin invitación.";
            }
            nameInput.value = "";
            emailInput.value = "";
            phoneInput.value = "";
            roleSelect.value = "TENANT_USER";
            loadTenants().catch(() => {});
          } else if (res.status === 409) {
            note.textContent = "El email ya está en uso en otra corredora.";
          } else {
            note.textContent = "No se pudo crear el usuario.";
          }
        }));

        fetchTenantUsers(t.id).then((users) => {
          body.innerHTML = "";
          if (!users.length) {
            body.appendChild(Object.assign(document.createElement("div"), { className: "note", textContent: "Sin usuarios aún." }));
            return;
          }
          users.forEach((u) => {
            const fullName = document.createElement("div");
            fullName.textContent = u.fullName || "—";
            const email = document.createElement("div");
            email.textContent = u.email || "—";
            const phone = document.createElement("div");
            phone.textContent = u.phone || "—";
            const role = document.createElement("div");
            role.textContent = u.role === "TENANT_ADMIN" ? "Admin" : "Ejecutivo";
            const invited = document.createElement("div");
            invited.textContent = formatDateShort(u.invitedAt);
            const status = document.createElement("div");
            status.textContent = u.status || "PENDING";
            const action = document.createElement("div");
            if (String(u.status || "").toUpperCase() === "PENDING" && !u.invitedAt) {
              const inviteBtn = document.createElement("button");
              inviteBtn.className = "btn outline";
              inviteBtn.textContent = "Invitar";
              inviteBtn.addEventListener("click", async () => {
                const res = await fetch(`/api/admin/users/${u.id}/invite`, { method: "POST" });
                const data = await res.json();
              if (res.ok) {
                const phoneSafe = String(u.phone || "").replace(/\D/g, "");
                const activationLink = buildActivationLink(data.activationUrl);
                const text = `Hola ${u.fullName || ""}, activa tu cuenta aquí: ${activationLink}. Luego ingresa desde tu celular en ${window.location.origin}/executive`;
                const waUrl = phoneSafe
                  ? `https://wa.me/${phoneSafe}?text=${encodeURIComponent(text)}`
                  : null;
                note.innerHTML = waUrl
                  ? `Invitación creada. <a href="${waUrl}" target="_blank">Enviar por WhatsApp</a>`
                  : `Invitación creada. Link: ${activationLink}`;
                loadTenants().catch(() => {});
              } else {
                note.textContent = "No se pudo invitar.";
              }
              });
              action.appendChild(inviteBtn);
            } else {
              action.textContent = "—";
            }
            body.appendChild(fullName);
            body.appendChild(email);
            body.appendChild(phone);
            body.appendChild(role);
            body.appendChild(invited);
            body.appendChild(status);
            body.appendChild(action);
          });
        }).catch(() => {});
      });
    }

    async function loadTenants() {
      try {
        const list = await fetchTenants();
        renderTenants(list);
      } catch {}
    }

    document.getElementById("createTenantBtn").addEventListener("click", async () => {
      const name = document.getElementById("tenantName").value.trim();
      const legalName = document.getElementById("tenantLegalName").value.trim();
      const rut = document.getElementById("tenantRut").value.trim();
      const password = document.getElementById("tenantPassword").value.trim();
      const email = document.getElementById("tenantEmail").value.trim();
      const phone = document.getElementById("tenantPhone").value.trim();
      if (!name) return alert("Nombre requerido.");
      const res = await fetch("/api/admin/tenants", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name,
          legalName: legalName || null,
          rut: rut || null,
          password: password || null,
          email: email || null,
          phone: phone || null
        })
      });
      const note = document.getElementById("tenantNote");
      if (res.ok) {
        note.textContent = "Corredora creada.";
      } else {
        note.textContent = "No se pudo crear la corredora.";
      }
      document.getElementById("tenantName").value = "";
      document.getElementById("tenantLegalName").value = "";
      document.getElementById("tenantRut").value = "";
      document.getElementById("tenantPassword").value = "";
      document.getElementById("tenantEmail").value = "";
      document.getElementById("tenantPhone").value = "";
      loadTenants().catch(() => {});
    });

    loadTenants().catch(() => {});

    function setActiveSection() {
      const hash = String(window.location.hash || "").replace("#", "");
      const section = hash || "score";
      document.querySelectorAll("[data-section]").forEach((el) => {
        const key = el.getAttribute("data-section");
        el.classList.toggle("hidden", key !== section);
      });
      document.querySelectorAll("[data-section-link]").forEach((el) => {
        const key = el.getAttribute("data-section-link");
        el.classList.toggle("active", key === section);
      });
    }

    window.addEventListener("hashchange", setActiveSection);
    setActiveSection();
  </script>
</body>
</html>
